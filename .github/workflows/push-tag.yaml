name: Push tag
on:
    push:
        tags:
            - 'v*'
permissions:
    contents: read
    id-token: write
jobs:
    publish:
        name: Publish
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: CI
              uses: ./.github/actions/ci

            - name: Publish package
              working-directory: dist/shared-utils
              shell: bash
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: |
                  if [[ "$GITHUB_REF_NAME" == *"-"* ]]; then
                      TAG="${GITHUB_REF_NAME#*-}"
                      TAG="${TAG%%.*}"
                  else
                      TAG="latest"
                  fi

                  pnpm publish --access public --no-git-checks --tag "$TAG"
