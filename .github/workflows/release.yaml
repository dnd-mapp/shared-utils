name: Release
on:
    workflow_dispatch:
        inputs:
            version:
                description: The version to release
                required: true
                type: choice
                options:
                    - major
                    - minor
                    - patch
                    - premajor
                    - preminor
                    - prepatch
                    - prerelease
            prerelease-id:
                description: The ID of the prerelease
                type: choice
                default: none
                options:
                    - none
                    - alpha
                    - beta
                    - rc
permissions:
    contents: write
jobs:
    bump-version:
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up tools
              uses: ./.github/actions/setup-tools
              with:
                  install-dependencies: false

            - name: Validate inputs
              id: validate-inputs
              shell: bash
              env:
                  VERSION: ${{ inputs.version }}
                  PRERELEASE_ID: ${{ inputs.prerelease-id }}
              run: node .github/scripts/validate-release-inputs.js

            - name: Generate app token
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ secrets.AUTH_APP_ID }}
                  private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}

            - name: Get bot user info
              id: bot-user
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  USER_ID=$(gh api /users/${{ steps.app-token.outputs.app-slug }}[bot] --jq '.id')
                  echo "name=${{ steps.app-token.outputs.app-slug }}[bot]" >> "$GITHUB_OUTPUT"
                  echo "email=${USER_ID}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com" >> "$GITHUB_OUTPUT"

            - name: Configure git
              shell: bash
              run: |
                  git config user.name "${{ steps.bot-user.outputs.name }}"
                  git config user.email "${{ steps.bot-user.outputs.email }}"

            - name: Bump version
              id: bump-version
              shell: bash
              run: |
                  VERSION_INPUT="${{ inputs.version }}"
                  PRERELEASE_ID_INPUT="${{ inputs.prerelease-id }}"

                  if [[ "$PRERELEASE_ID_INPUT" == "none" ]]; then
                      RAW_VERSION=$(pnpm version "$VERSION_INPUT" --no-commit-hooks --no-workspaces-update --no-git-tag-version)
                  else
                      RAW_VERSION=$(pnpm version "$VERSION_INPUT" --no-commit-hooks --no-workspaces-update --no-git-tag-version --preid "$PRERELEASE_ID_INPUT")
                  fi

                  RAW_VERSION=$(echo "$RAW_VERSION" | xargs)
                  RAW_VERSION="${RAW_VERSION##* }"
                  CLEAN_VERSION="${RAW_VERSION#v}"

                  echo "raw-version=$RAW_VERSION" >> $GITHUB_OUTPUT
                  echo "clean-version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

            - name: Prepare release notes
              shell: bash
              env:
                  CLEAN_VERSION: ${{ steps.bump-version.outputs.clean-version }}
              run: node .github/scripts/prepare-release-notes.js

            - name: Update changelog
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  REPO="${{ github.repository }}"
                  BRANCH="${{ github.ref_name }}"
                  CHANGELOG_PATH="CHANGELOG.md"
                  COMMIT_MESSAGE="Chore: Update changelog for ${{ steps.bump-version.outputs.clean-version }}"

                  CURRENT_SHA=$(gh api "repos/$REPO/contents/$CHANGELOG_PATH" \
                      --jq '.sha' -H "Accept: application/vnd.github.v3+json")

                  COMMIT_SHA=$(gh api "repos/$REPO/contents/$CHANGELOG_PATH" --method PUT -f message="$COMMIT_MESSAGE" \
                      -f content="$(base64 -w0 "$CHANGELOG_PATH")" -f sha="$CURRENT_SHA" -f branch="$BRANCH" \
                  --jq '.commit.sha')

            - name: Update package manifest
              id: commit-manifest
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  REPO="${{ github.repository }}"
                  BRANCH="${{ github.ref_name }}"
                  COMMIT_MESSAGE="${{ steps.bump-version.outputs.clean-version }}"
                  MANIFEST_PATH="package.json"

                  # Get the current file SHA (required by the Contents API for updates)
                  FILE_SHA=$(gh api repos/$REPO/contents/$MANIFEST_PATH --jq '.sha')

                  # Base64-encode the file content
                  CONTENT=$(base64 -w0 "$MANIFEST_PATH")

                  # Commit via the Contents API â€” GitHub signs this automatically
                  NEW_COMMIT_SHA=$(gh api repos/$REPO/contents/$MANIFEST_PATH --method PUT -f message="$COMMIT_MESSAGE" \
                      -f content="$CONTENT" -f sha="$FILE_SHA" -f branch="$BRANCH" \
                  --jq '.commit.sha')

                  echo "commit-sha=$NEW_COMMIT_SHA" >> $GITHUB_OUTPUT

            - name: Create Release
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  NEW_TAG_NAME="${{ steps.bump-version.outputs.raw-version }}"

                  gh release create "$NEW_TAG_NAME" --title "$NEW_TAG_NAME" \
                      --target "${{ steps.commit-manifest.outputs.commit-sha }}" \
                      --notes-file .github/release-notes.md \
                      --latest=${{ steps.validate-inputs.outputs.is-prerelease == 'false' }} \
                      --prerelease=${{ steps.validate-inputs.outputs.is-prerelease == 'true' }}
